<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Historical Weather | MeteoVeritas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <style>
    .history-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      margin: 10px;
      background-color: #f9f9f9;
      width: 200px;
      display: inline-block;
      vertical-align: top;
    }
  </style>
</head>
<body>
  <header class="mv-header">
    <a class="mv-logo" href="/"><img src="/assets/img/placeholder-logo.svg" alt="MeteoVeritas logo" width="160" height="48"></a>
    <nav class="mv-nav">
      <a href="/weather.html">Weather Center</a>
      <a href="/historical.html" class="active">Historical Weather</a>
      <a href="/wbgt.html">WBGT Center</a>
      <a href="/consulting.html">Consulting</a>
      <a href="/contact.html" class="mv-cta-btn">Request Services</a>
    </nav>
  </header>

  <main class="mv-weather-wrapper">
    <h1>Weather History Lookup</h1>
    <p>Enter a city and select a date range to view historical weather data.</p>
    <form id="historical-form">
      <input type="text" id="zip-code" placeholder="e.g., Dunedin, FL">
      <label for="start-date">Start Date:</label>
      <input type="date" id="start-date" required>
      <label for="end-date">End Date:</label>
      <input type="date" id="end-date" required>
      <button type="submit" class="mv-btn-primary">Get History</button>
    </form>

    <div id="weather-history"></div>
  </main>

  <footer class="mv-footer">
    <p>Data: Meteostat & Open-Meteo Geocoding API.</p>
    <p>© <span id="mv-year"></span> MeteoVeritas.</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("historical-form");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const location = document.getElementById("zip-code").value.trim();
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;

        if (!location || !startDate || !endDate) {
          alert("Please complete all fields.");
          return;
        }

        await getHistoricalWeather(location, startDate, endDate);
      });
    });

    async function getHistoricalWeather(location, startDate, endDate) {
      try {
        const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1`);
        const geoData = await geoRes.json();
        const place = geoData.results?.[0];

        if (!place) {
          alert("Could not find location.");
          return;
        }

        const { latitude, longitude, name, admin1 } = place;

        const response = await fetch(`https://meteostat.p.rapidapi.com/point/daily?lat=${latitude}&lon=${longitude}&start=${startDate}&end=${endDate}&units=imperial`, {
          method: 'GET',
          headers: {
            'x-rapidapi-host': 'meteostat.p.rapidapi.com',
            'x-rapidapi-key': '4500430017msh37a9cc063754634p1bd356jsn1122cd12aa3e'
          }
        });

        const data = await response.json();
        if (!data.data || data.data.length === 0) {
          alert("No data available for this date range.");
          return;
        }

        const container = document.getElementById("weather-history");
        container.innerHTML = `<h3>Weather History: ${name}, ${admin1}</h3>`;

        data.data.forEach(day => {
          const card = document.createElement("div");
          card.className = "history-card";
          card.innerHTML = `
            <strong>${day.date}</strong><br>
            High: ${day.tmax ?? '—'} °F<br>
            Low: ${day.tmin ?? '—'} °F<br>
            Avg Temp: ${day.tavg ?? '—'} °F<br>
            Precip: ${day.prcp ?? 0} in<br>
            Snow: ${day.snow ?? 0} in
          `;
          container.appendChild(card);
        });

      } catch (error) {
        console.error("Error getting weather history:", error);
        alert("Failed to load data. Try again later.");
      }
    }
  </script>
</body>
</html>
