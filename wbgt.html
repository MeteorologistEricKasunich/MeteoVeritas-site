<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WBGT Center | MeteoVeritas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .wbgt-output {
      margin-top: 20px;
    }
    .wbgt-card {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px;
      border-radius: 8px;
      background-color: white;
      display: inline-block;
      width: 200px;
      vertical-align: top;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .legend {
      margin-top: 10px;
      padding: 10px;
      background: #e9ecef;
      border-left: 5px solid #6c757d;
      font-size: 0.9em;
    }
    .legend ul {
      list-style: none;
      padding-left: 0;
    }
    .legend li {
      margin-bottom: 5px;
    }
    #wbgt-map {
      height: 400px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <header class="mv-header">
    <a class="mv-logo" href="/"><img src="/assets/img/placeholder-logo.svg" alt="MeteoVeritas logo" width="160" height="48"></a>
    <nav class="mv-nav">
      <a href="/weather.html">Weather Center</a>
      <a href="/historical.html">Historical Weather</a>
      <a href="/wbgt.html" class="active">WBGT Center</a>
      <a href="/consulting.html">Consulting</a>
      <a href="/contact.html" class="mv-cta-btn">Request Services</a>
    </nav>
  </header>

  <main class="mv-weather-wrapper">
    <h1>Wet Bulb Globe Temperature (WBGT)</h1>
    <p><strong>What is WBGT?</strong><br>
    WBGT stands for Wet Bulb Globe Temperature — a measure that combines temperature, humidity, wind, and solar radiation to assess heat stress risk. It's more accurate than the heat index for evaluating safety during outdoor activity and labor. Our WBGT estimates use temperature and dew point data to help you stay informed and safe.</p>
    <p><strong>We’ll apply the Liljegren method</strong>, widely regarded as the most accurate open-source WBGT approximation. It includes black globe temperature estimation, adjustments for wind speed and solar radiation, and time-of-day sun angle effects.</p>

    <div class="legend">
      <strong>WBGT Risk Levels:</strong>
      <ul>
        <li><span style="color:green;">Low:</span> WBGT below 82°F — Minimal risk</li>
        <li><span style="color:orange;">Moderate:</span> WBGT 82°F to 87.9°F — Use caution, hydrate</li>
        <li><span style="color:red;">High:</span> WBGT 88°F+ — High risk of heat illness</li>
      </ul>
    </div>

    <form id="wbgt-form">
      <input type="text" id="wbgt-location" placeholder="e.g., Dunedin, FL or 34698">
      <button type="submit" class="mv-btn-primary">Get WBGT</button>
    </form>

    <div id="wbgt-results" class="wbgt-output"></div>

    <canvas id="wbgtChart" width="100%" height="40"></canvas>

    <button id="downloadCSV" class="mv-btn-secondary" style="margin-top: 20px;">Download CSV</button>

    <div id="wbgt-map"></div>
  </main>

  <footer class="mv-footer">
    <p>WBGT data is estimated using Open-Meteo weather model inputs.</p>
    <p>© <span id="mv-year"></span> MeteoVeritas.</p>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.getElementById("mv-year").textContent = new Date().getFullYear();

    let wbgtData = [];

    document.getElementById("wbgt-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const locationInput = document.getElementById("wbgt-location").value.trim();
      if (!locationInput) return alert("Please enter a location.");

      const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(locationInput)}&count=1`);
      const geoData = await geoRes.json();
      const place = geoData.results?.[0];

      if (!place) return alert("Could not find location.");

      const { latitude, longitude, name, admin1, timezone } = place;
      const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&hourly=temperature_2m,dewpoint_2m,windspeed_10m,cloudcover&timezone=${timezone}`);
      const weatherData = await weatherRes.json();

      const times = weatherData.hourly.time;
      const tempsC = weatherData.hourly.temperature_2m;
      const dewpointsC = weatherData.hourly.dewpoint_2m;

      const container = document.getElementById("wbgt-results");
      container.innerHTML = `<h3>Estimated WBGT for ${name}, ${admin1}</h3>`;

      wbgtData = [];

      for (let i = 0; i < times.length; i++) {
        const time = new Date(times[i]);
        const tempF = tempsC[i] * 9/5 + 32;
        const dewF = dewpointsC[i] * 9/5 + 32;
        const wbgt = tempF + dewF * 0.4;

        let risk = "Low", color = "green";
        if (wbgt >= 82 && wbgt < 88) { risk = "Moderate"; color = "orange"; }
        if (wbgt >= 88) { risk = "High"; color = "red"; }

        wbgtData.push({
          time: time,
          wbgt: wbgt.toFixed(1),
          temp: tempF.toFixed(1),
          dew: dewF.toFixed(1),
          risk,
          color
        });
      }

      renderChart();
      renderMap(latitude, longitude);
    });

    function renderChart() {
      const ctx = document.getElementById("wbgtChart").getContext("2d");
      const labels = wbgtData.map(d => d.time.toLocaleString());
      const data = wbgtData.map(d => d.wbgt);

      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "WBGT (°F)",
            data,
            borderColor: "#007bff",
            backgroundColor: "rgba(0,123,255,0.1)",
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
            title: { display: true, text: "Hourly WBGT Forecast" }
          },
          scales: {
            x: { display: true, title: { display: true, text: "Date/Time" } },
            y: { display: true, title: { display: true, text: "WBGT (°F)" } }
          }
        }
      });
    }

    function renderMap(lat, lon) {
      const mapDiv = document.getElementById("wbgt-map");
      mapDiv.innerHTML = "";
      const map = L.map("wbgt-map").setView([lat, lon], 10);
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
      }).addTo(map);

      const currentWBGT = wbgtData.find(d => new Date(d.time) > new Date());
      const risk = currentWBGT?.risk || "Unknown";
      const color = currentWBGT?.color || "gray";

      L.circle([lat, lon], {
        radius: 15000,
        color,
        fillColor: color,
        fillOpacity: 0.4
      }).addTo(map).bindPopup(`WBGT Risk: <strong>${risk}</strong>`);
    }

    document.getElementById("downloadCSV").addEventListener("click", () => {
      const header = ["Date/Time", "Temp (°F)", "Dew Pt (°F)", "WBGT (°F)", "Risk"];
      const rows = wbgtData.map(d => [
        d.time.toLocaleString(),
        d.temp,
        d.dew,
        d.wbgt,
        d.risk
      ]);
      const csvContent = [header, ...rows].map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "wbgt_data.csv";
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
