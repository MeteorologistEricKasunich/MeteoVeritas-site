<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WBGT Center | MeteoVeritas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .wbgt-output {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      background-color: #f5f5f5;
    }
    .risk-low { background-color: #d4edda; }
    .risk-moderate { background-color: #fff3cd; }
    .risk-high { background-color: #f8d7da; }
    .wbgt-card {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px;
      border-radius: 8px;
      background-color: white;
      display: inline-block;
      width: 200px;
      vertical-align: top;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .legend {
      margin-top: 10px;
      padding: 10px;
      background: #e9ecef;
      border-left: 5px solid #6c757d;
      font-size: 0.9em;
    }
    .legend ul {
      list-style: none;
      padding-left: 0;
    }
    .legend li {
      margin-bottom: 5px;
    }
    .chart-container {
      max-width: 100%;
      margin-top: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <header class="mv-header">
    <a class="mv-logo" href="/"><img src="/assets/img/placeholder-logo.svg" alt="MeteoVeritas logo" width="160" height="48"></a>
    <nav class="mv-nav">
      <a href="/weather.html">Weather Center</a>
      <a href="/historical.html">Historical Weather</a>
      <a href="/wbgt.html" class="active">WBGT Center</a>
      <a href="/consulting.html">Consulting</a>
      <a href="/contact.html" class="mv-cta-btn">Request Services</a>
    </nav>
  </header>

  <main class="mv-weather-wrapper">
    <h1>Wet Bulb Globe Temperature (WBGT)</h1>
    <p><strong>What is WBGT?</strong><br>
      WBGT stands for Wet Bulb Globe Temperature — a measure that combines temperature, humidity, wind, and solar radiation to assess heat stress risk. It's more accurate than the heat index for evaluating safety during outdoor activity and labor. Our WBGT estimates use temperature and dew point data to help you stay informed and safe.
    </p>

    <div class="legend">
      <strong>WBGT Risk Levels:</strong>
      <ul>
        <li><span style="color:green;">Low:</span> WBGT below 82°F — Minimal risk</li>
        <li><span style="color:orange;">Moderate:</span> WBGT 82°F to 87.9°F — Use caution, hydrate</li>
        <li><span style="color:red;">High:</span> WBGT 88°F+ — High risk of heat illness</li>
      </ul>
    </div>

    <form id="wbgt-form">
      <input type="text" id="wbgt-location" placeholder="e.g., Dunedin, FL or 34698">
      <button type="submit" class="mv-btn-primary">Get WBGT</button>
    </form>

    <div id="wbgt-results" class="wbgt-output"></div>
    <div class="chart-container">
      <canvas id="wbgtChart" height="100"></canvas>
    </div>
  </main>

  <footer class="mv-footer">
    <p>WBGT data is estimated using Open-Meteo weather model inputs.</p>
    <p>© <span id="mv-year"></span> MeteoVeritas.</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("mv-year").textContent = new Date().getFullYear();

      document.getElementById("wbgt-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const location = document.getElementById("wbgt-location").value.trim();
        if (!location) return alert("Please enter a location.");

        const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1`);
        const geoData = await geoRes.json();
        const place = geoData.results?.[0];

        if (!place) {
          alert("Could not find location.");
          return;
        }

        const { latitude, longitude, name, admin1, timezone } = place;
        const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&hourly=temperature_2m,dewpoint_2m&timezone=${timezone}`);
        const weatherData = await weatherRes.json();

        const times = weatherData.hourly.time;
        const tempsC = weatherData.hourly.temperature_2m;
        const dewpointsC = weatherData.hourly.dewpoint_2m;

        const container = document.getElementById("wbgt-results");
        container.innerHTML = `<h3>Estimated WBGT for ${name}, ${admin1}</h3>`;

        const chartLabels = [];
        const chartWBGTs = [];

        for (let i = 0; i < times.length; i++) {
          const dateObj = new Date(times[i]);
          const hour = dateObj.getHours();
          if (hour < 12 || hour > 17) continue;

          const tempF = (tempsC[i] * 9/5 + 32).toFixed(1);
          const dewF = (dewpointsC[i] * 9/5 + 32).toFixed(1);
          const wbgt = (parseFloat(tempF) + parseFloat(dewF) * 0.4).toFixed(1);

          let risk = "Low", riskClass = "risk-low";
          if (wbgt >= 82 && wbgt < 88) { risk = "Moderate"; riskClass = "risk-moderate"; }
          if (wbgt >= 88) { risk = "High"; riskClass = "risk-high"; }

          const timeStr = dateObj.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
          const dateStr = dateObj.toLocaleDateString();

          chartLabels.push(`${timeStr}`);
          chartWBGTs.push(wbgt);

          const card = document.createElement("div");
          card.className = `wbgt-card ${riskClass}`;
          card.innerHTML = `
            <div class="date-label">${dateStr}</div>
            <strong>${timeStr}</strong>
            Temp: ${tempF} °F<br>
            Dew Pt: ${dewF} °F<br>
            WBGT: ${wbgt} °F<br>
            <span class="${riskClass}">Risk: ${risk}</span>
          `;
          container.appendChild(card);
        }

        // Chart.js graph
        const ctx = document.getElementById('wbgtChart').getContext('2d');
        if (window.wbgtChartInstance) window.wbgtChartInstance.destroy();
        window.wbgtChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: chartLabels,
            datasets: [{
              label: 'WBGT (°F)',
              data: chartWBGTs,
              fill: true,
              borderColor: 'rgba(255,99,132,1)',
              backgroundColor: 'rgba(255,99,132,0.1)',
              tension: 0.3,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: { display: true, text: 'WBGT Forecast (12–5 PM)' }
            },
            scales: {
              y: {
                title: { display: true, text: 'WBGT (°F)' },
                beginAtZero: false
              }
            }
          }
        });
      });
    });
  </script>
</body>
</html>
