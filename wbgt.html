<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WBGT Center | MeteoVeritas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f8fb;
      color: #222;
      margin: 0;
      padding: 0;
    }
    .mv-header, .mv-footer {
      background-color: #003366;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .mv-nav a {
      color: white;
      margin: 0 10px;
      text-decoration: none;
    }
    .mv-weather-wrapper {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    h1, h3 {
      color: #003366;
    }
    .legend {
      background: #e2e3e5;
      border-left: 5px solid #6c757d;
      padding: 10px;
      margin-bottom: 20px;
    }
    .legend ul {
      list-style: none;
      padding: 0;
    }
    .legend li {
      margin: 5px 0;
    }
    .risk-low { background-color: #d4edda; }
    .risk-moderate { background-color: #fff3cd; }
    .risk-high { background-color: #f8d7da; }
    .chart-container {
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .mv-cta-btn {
      display: inline-block;
      background: #007bff;
      color: white;
      padding: 10px 16px;
      border-radius: 5px;
      text-decoration: none;
    }
    input[type="text"] {
      padding: 8px;
      width: 250px;
      margin-right: 8px;
    }
    .mv-btn-primary {
      background: #007bff;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header class="mv-header">
    <a class="mv-logo" href="/"><img src="/assets/img/placeholder-logo.svg" alt="MeteoVeritas logo" width="160"></a>
    <nav class="mv-nav">
      <a href="/weather.html">Weather Center</a>
      <a href="/historical.html">Historical Weather</a>
      <a href="/wbgt.html" class="active">WBGT Center</a>
      <a href="/consulting.html">Consulting</a>
      <a href="/contact.html" class="mv-cta-btn">Request Services</a>
    </nav>
  </header>

  <main class="mv-weather-wrapper">
    <h1>Wet Bulb Globe Temperature (WBGT)</h1>
    <p><strong>What is WBGT?</strong><br>
    WBGT stands for Wet Bulb Globe Temperature — a comprehensive measure of heat stress that incorporates air temperature, humidity, wind speed, and solar radiation. It is more accurate than heat index for assessing heat illness risk, especially for athletes, workers, and outdoor activities.<br><br>
    <strong>We apply the Liljegren method</strong>, widely regarded as the most accurate open-source WBGT approximation. It includes:<br>
    - Black globe temperature estimate<br>
    - Adjustments for wind speed and solar radiation<br>
    - Time-of-day + sun angle effects
    </p>

    <div class="legend">
      <strong>WBGT Risk Levels:</strong>
      <ul>
        <li><span style="color:green;">Low:</span> WBGT below 82°F — Minimal risk</li>
        <li><span style="color:orange;">Moderate:</span> WBGT 82°F to 87.9°F — Use caution, hydrate</li>
        <li><span style="color:red;">High:</span> WBGT 88°F+ — High risk of heat illness</li>
      </ul>
    </div>

    <form id="wbgt-form">
      <input type="text" id="wbgt-location" placeholder="e.g., Dunedin, FL or 34698">
      <button type="submit" class="mv-btn-primary">Get WBGT</button>
    </form>

    <div id="wbgt-results" class="chart-container">
      <canvas id="wbgt-chart" width="100%" height="60"></canvas>
    </div>
  </main>

  <footer class="mv-footer">
    <p>WBGT data is estimated using Open-Meteo weather model inputs + Liljegren approximation.</p>
    <p>© <span id="mv-year"></span> MeteoVeritas</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("mv-year").textContent = new Date().getFullYear();

      const form = document.getElementById("wbgt-form");
      const chartCtx = document.getElementById("wbgt-chart").getContext("2d");
      let wbgtChart;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const location = document.getElementById("wbgt-location").value.trim();
        if (!location) return alert("Please enter a location.");

        const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1`);
        const geoData = await geoRes.json();
        const place = geoData.results?.[0];

        if (!place) return alert("Could not find location.");
        const { latitude, longitude, name, admin1, timezone } = place;

        const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&hourly=temperature_2m,dewpoint_2m&timezone=${timezone}`);
        const weatherData = await weatherRes.json();

        const times = weatherData.hourly.time;
        const tempsC = weatherData.hourly.temperature_2m;
        const dewpointsC = weatherData.hourly.dewpoint_2m;

        const labels = [];
        const wbgtValues = [];
        const backgroundColors = [];

        for (let i = 0; i < times.length; i++) {
          const time = new Date(times[i]);
          const tempF = tempsC[i] * 9 / 5 + 32;
          const dewF = dewpointsC[i] * 9 / 5 + 32;
          const wbgt = (tempF + 0.4 * dewF).toFixed(1);

          labels.push(time.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }));
          wbgtValues.push(wbgt);

          if (wbgt < 82) backgroundColors.push("green");
          else if (wbgt < 88) backgroundColors.push("orange");
          else backgroundColors.push("red");
        }

        if (wbgtChart) wbgtChart.destroy();
        wbgtChart = new Chart(chartCtx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: `WBGT Forecast for ${name}, ${admin1}`,
              data: wbgtValues,
              backgroundColor: backgroundColors,
              borderColor: "#003366",
              fill: false,
              tension: 0.2,
              pointRadius: 4
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                title: { display: true, text: 'WBGT (°F)' }
              },
              x: {
                title: { display: true, text: 'Local Time' }
              }
            }
          }
        });
      });
    });
  </script>
</body>
</html>
