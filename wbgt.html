<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WBGT Center | MeteoVeritas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <style>
    .wbgt-output {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      background-color: #f5f5f5;
    }
    .risk-low { background-color: #d4edda; }
    .risk-moderate { background-color: #fff3cd; }
    .risk-high { background-color: #f8d7da; }
    .wbgt-card {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px;
      border-radius: 8px;
      background-color: white;
      display: inline-block;
      width: 180px;
      vertical-align: top;
    }
  </style>
</head>
<body>
  <header class="mv-header">
    <a class="mv-logo" href="/"><img src="/assets/img/placeholder-logo.svg" alt="MeteoVeritas logo" width="160" height="48"></a>
    <nav class="mv-nav">
      <a href="/weather.html">Weather Center</a>
      <a href="/historical.html">Historical Weather</a>
      <a href="/wbgt.html" class="active">WBGT Center</a>
      <a href="/consulting.html">Consulting</a>
      <a href="/contact.html" class="mv-cta-btn">Request Services</a>
    </nav>
  </header>

  <main class="mv-weather-wrapper">
    <h1>Wet Bulb Globe Temperature (WBGT)</h1>
    <p>Enter a location to see estimated WBGT values and heat safety risk levels.</p>
    <form id="wbgt-form">
      <input type="text" id="wbgt-location" placeholder="e.g., Dunedin, FL or 34698">
      <button type="submit" class="mv-btn-primary">Get WBGT</button>
    </form>

    <div id="wbgt-results" class="wbgt-output"></div>
  </main>

  <footer class="mv-footer">
    <p>WBGT data is estimated using Open-Meteo weather model inputs.</p>
    <p>© <span id="mv-year"></span> MeteoVeritas.</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const year = new Date().getFullYear();
      document.getElementById("mv-year").textContent = year;

      document.getElementById("wbgt-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const location = document.getElementById("wbgt-location").value.trim();
        if (!location) return alert("Please enter a location.");

        const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1`);
        const geoData = await geoRes.json();
        const place = geoData.results?.[0];

        if (!place) {
          alert("Could not find location.");
          return;
        }

        const { latitude, longitude, name, admin1, timezone } = place;

        const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&hourly=temperature_2m,dewpoint_2m,windspeed_10m,cloudcover&timezone=${timezone}`);
        const weatherData = await weatherRes.json();

        const times = weatherData.hourly.time;
        const tempsC = weatherData.hourly.temperature_2m;
        const dewpointsC = weatherData.hourly.dewpoint_2m;

        const localNow = new Date();
        const todayStr = localNow.toISOString().split("T")[0];

        const container = document.getElementById("wbgt-results");
        container.innerHTML = `<h3>Estimated WBGT for ${name}, ${admin1}</h3>`;

        for (let i = 0; i < times.length; i++) {
          if (!times[i].startsWith(todayStr)) continue;
          const hour = parseInt(times[i].split("T")[1].split(":"[0]));
          if (hour < 12 || hour > 17) continue;

          const tempF = (tempsC[i] * 9/5 + 32).toFixed(1);
          const dewF = (dewpointsC[i] * 9/5 + 32).toFixed(1);
          const wbgt = (parseFloat(tempF) + parseFloat(dewF) * 0.4).toFixed(1);

          let risk = "Low", riskClass = "risk-low";
          if (wbgt >= 82 && wbgt < 88) { risk = "Moderate"; riskClass = "risk-moderate"; }
          if (wbgt >= 88) { risk = "High"; riskClass = "risk-high"; }

          const card = document.createElement("div");
          card.className = `wbgt-card ${riskClass}`;
          card.innerHTML = `
            <strong>${times[i].split("T")[1]}</strong><br>
            Temp: ${tempF} °F<br>
            Dew Pt: ${dewF} °F<br>
            WBGT: ${wbgt} °F<br>
            Risk: ${risk}
          `;
          container.appendChild(card);
        }
      });
    });
  </script>
</body>
</html>
